<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Gestión de Impresoras - Piatto</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link id="dynamic-css" rel="stylesheet" />
  </head>
  <body>
    <div class="container-fluid">
      <!-- Encabezado con logo e idiomas -->
      <div
        class="row header-container align-items-center justify-content-between"
      >
        <div class="col-auto logo-container">
          <img id="logo-image" alt="Logo" class="logo-image" />
        </div>
        <div class="col-auto version-container">
          <span class="badge bg-secondary">v1.0.1</span>
        </div>
        <div class="col-auto language-container">
          <div class="dropdown">
            <button
              class="btn btn-secondary dropdown-toggle"
              type="button"
              id="languageDropdown"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <img
                id="current-flag"
                alt="Idioma actual"
                style="width: 32px; height: 22px"
              />
            </button>
            <ul class="dropdown-menu" aria-labelledby="languageDropdown">
              <li>
                <a
                  class="dropdown-item"
                  href="#"
                  onclick="changeLanguage('es')"
                >
                  <img
                    id="flag-es"
                    alt="Español"
                    style="width: 20px; height: 20px"
                  />
                </a>
              </li>
              <li>
                <a
                  class="dropdown-item"
                  href="#"
                  onclick="changeLanguage('en')"
                >
                  <img
                    id="flag-en"
                    alt="English"
                    style="width: 20px; height: 20px"
                  />
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Contenido principal -->
      <div class="row content-container">
        <div class="col-12 text-start my-3">
          <h3 id="main-header"></h3>
          <div class="col-12 text-end mb-3">
            <button id="refresh-button" class="btn btn-outline-primary">
              🔄 Actualizar impresoras
            </button>
          </div>
          <p id="header-description"></p>
        </div>
        <div class="col-12 printer-list">
          <div class="container-fluid printer-container">
            <div class="row row-no-gutters" id="printer-container"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      document
        .getElementById("refresh-button")
        .addEventListener("click", async () => {
          updatePrinterUI([]);
          try {
            const response = await fetch(
              `http://${localIP}:3001/api/v1/impresoras/actualizar`
            );
            const result = await response.json();
            if (result.success) {
              printers = result.printers;
              updatePrinterUI(printers);
            } else {
              alert("No se pudo actualizar el estado de las impresoras.");
            }
          } catch (err) {
            alert("Error al actualizar impresoras.");
            console.error(err);
          }
        });

      document.getElementById(
        "dynamic-css"
      ).href = `${window.paths.assetsPath}/style.css`;

      let localIP, port;
      let translations = {};
      let currentLanguage = "es";
      let printers = []; // Almacenaremos los datos de las impresoras aquí

      async function loadTranslations() {
        const allTranslations = await window.electron.ipcRenderer.invoke(
          "get-translations",
          currentLanguage
        );
        translations = allTranslations.interfaz || {}; // <<< CORRECCIÓN AQUÍ
        console.log("Traducciones cargadas:", translations);
      }

      function changeLanguage(language) {
        currentLanguage = language;
        document.getElementById(
          "current-flag"
        ).src = `${window.paths.assetsPath}/flags/${language}.svg`;

        loadTranslations().then(() => {
          updateInterface();
          updatePrinterUI(printers); // Recarga la UI de impresoras con el nuevo idioma
        });
      }

      function updateInterface() {
        console.log("Actualizo título con:", translations.title);
        document.title = translations.title;
        document.getElementById("main-header").textContent =
          translations.header.main;
        document.getElementById("header-description").textContent =
          translations.header.description;
      }

      async function requestServerInfo() {
        try {
          const serverInfo = await window.electron.ipcRenderer.invoke(
            "request-server-info"
          );
          localIP = serverInfo.localIP;
          port = serverInfo.port;
          initializeWebSocket();
        } catch (error) {
          console.error(
            "Error al solicitar la información del servidor:",
            error
          );
        }
      }

      function initializeWebSocket() {
        const ws = new WebSocket(`ws://${localIP}:${port}`);

        ws.onopen = async () => {
          console.log("Conectado al WebSocket del servidor");

          // Asegurar que traducciones estén cargadas antes de mostrar el spinner
          if (!translations.status || !translations.buttons) {
            await loadTranslations();
          }

          updatePrinterUI([]); // Mostrar el spinner después de cargar traducciones
        };

        ws.onmessage = async (event) => {
          printers = JSON.parse(event.data);

          if (!translations.status || !translations.buttons) {
            await loadTranslations();
          }

          console.log("Impresoras en html:", printers);
          updatePrinterUI(printers);
        };

        ws.onerror = (error) => console.error("Error en WebSocket:", error);
        ws.onclose = () => console.log("Conexión WebSocket cerrada");
      }

      async function testPrinter(printerName) {
        try {
          const response = await fetch(
            `http://${localIP}:3001/api/v1/impresion/prueba`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Accept-Language": currentLanguage,
              },
              body: JSON.stringify({ printerName }),
            }
          );

          const result = await response.json();
          if (result.success) {
            alert(translations.alerts.test_success);
          } else {
            alert(translations.alerts.test_error);
          }
        } catch (error) {
          alert(translations.alerts.test_error);
        }
      }

      function updatePrinterUI(printers) {
        const container = document.getElementById("printer-container");
        container.innerHTML = "";

        if (!translations.status || !translations.buttons) {
          showLoadingSpinner();
          return;
        }

        if (!printers || printers.length === 0) {
          container.innerHTML = `
      <div class="col-12 text-center my-5">
        <div class="spinner-border text-light" role="status"></div>
        <p class="mt-3">${
          translations.loading?.title || "Cargando impresoras..."
        }</p>
      </div>
    `;
          return;
        }

        printers.forEach((printer) => {
          const printerDiv = document.createElement("div");
          printerDiv.className = "col-sm-6 col-md-4 col-lg-4 mb-4";

          console.log("Impresora:", printer);

          // Verificación más robusta del estado
          let statusClass = "badge-inactiva";
          let statusText = translations.status.disconnected;

          if (printer.status === "Imprimiendo") {
            statusClass = "badge-imprimiendo";
            statusText = translations.status.printing;
          } else if (printer.status === "Conectada") {
            statusClass = printer.default
              ? "badge-conectada-primary"
              : "badge-conectada";
            statusText = translations.status.connected;
          } else if (printer.status === "Error") {
            statusClass = "badge-error";
            statusText = translations.status.error;
          }

          printerDiv.innerHTML = `
      <div class="card bg-dark text-white shadow printer-card">
        <div class="card-body text-center">
          <div class="badge-container">
            <span class="badge ${statusClass}">
              <span class="dot"></span> ${statusText}
              ${printer.default ? ` (${translations.buttons.default})` : ""}
            </span>
          </div>
          <img src="${
            window.paths.assetsPath
          }/impresora.png" alt="Impresora" class="printer-image mb-3">
          <h5 class="card-title mt-2">${printer.name}</h5>
          <button class="btn btn-test" onclick="testPrinter('${printer.name.replace(
            /'/g,
            "\\'"
          )}')">
            ${translations.buttons.test_print}
          </button>
        </div>
      </div>
    `;
          container.appendChild(printerDiv);
        });
      }

      function showLoadingSpinner() {
        const container = document.getElementById("printer-container");
        container.innerHTML = `
    <div class="col-12 text-center my-5">
      <div class="spinner-border text-light" role="status"></div>
      <p class="mt-3">${
        translations.loading?.title || "Cargando impresoras..."
      }</p>
    </div>
  `;
      }

      window.onload = () => {
        document.getElementById(
          "logo-image"
        ).src = `${window.paths.assetsPath}/logo.png`;
        document.getElementById(
          "current-flag"
        ).src = `${window.paths.assetsPath}/flags/es.svg`;
        document.getElementById(
          "flag-es"
        ).src = `${window.paths.assetsPath}/flags/es.svg`;
        document.getElementById(
          "flag-en"
        ).src = `${window.paths.assetsPath}/flags/en.svg`;

        loadTranslations().then(() => {
          updateInterface();
          requestServerInfo();
        });
      };
    </script>
  </body>
</html>
